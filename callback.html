<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Spotify Login - Redirecting...</title>
    <style>
        body {
            background-color: #000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .loading {
            text-align: center;
            max-width: 400px;
            padding: 20px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #1DB954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        a {
            color: #1DB954;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <p id="status">Logging in...</p>
    </div>
    <script>
        const clientId = '0ef8dfe4fff64ceab824505fc1b3f963';
        const redirectUri = 'https://fourfan.github.io/Guess-The-Song/callback.html';

        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                showError('Login failed: ' + (params.get('error_description') || error));
                return;
            }

            if (!code) {
                // No code, redirect to home
                window.location.href = '/Guess-The-Song/';
                return;
            }

            // Check if already logged in (token exists in sessionStorage)
            const existingToken = sessionStorage.getItem('spotify_access_token');
            if (existingToken) {
                // Already logged in, redirect to home
                window.location.href = '/Guess-The-Song/';
                return;
            }

            // Get the code verifier from sessionStorage
            const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
            if (!codeVerifier) {
                // No verifier means session expired or already used, redirect to home
                window.location.href = '/Guess-The-Song/';
                return;
            }

            // Exchange code for token
            try {
                document.getElementById('status').textContent = 'Exchanging code for token...';

                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: clientId,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: redirectUri,
                        code_verifier: codeVerifier,
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || errorData.error || 'Token exchange failed');
                }

                const data = await response.json();
                const accessToken = data.access_token;

                // Clear the code verifier
                sessionStorage.removeItem('spotify_code_verifier');

                // Redirect to main app with token in hash
                window.location.href = '/Guess-The-Song/#access_token=' + encodeURIComponent(accessToken);

            } catch (err) {
                // Token exchange failed (code already used or expired)
                // Clear verifier and redirect to home
                sessionStorage.removeItem('spotify_code_verifier');
                window.location.href = '/Guess-The-Song/';
            }
        }

        function showError(message) {
            document.querySelector('.loading').innerHTML =
                '<p class="error">' + message + '</p>' +
                '<p><a href="/Guess-The-Song/">Back to Home</a></p>';
        }

        handleCallback();
    </script>
</body>
</html>
